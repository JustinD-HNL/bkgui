<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buildkite Pipeline Builder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Firebase Authentication (if configured) -->
    <div id="auth-container" class="hidden">
        <div class="auth-card">
            <div class="auth-header">
                <i class="fab fa-google"></i>
                <h2>Sign in to Pipeline Builder</h2>
                <p>Secure access with your Google account</p>
            </div>
            <button id="google-signin-btn" class="btn btn-primary">
                <i class="fab fa-google"></i>
                Sign in with Google
            </button>
            <div id="auth-error" class="error-message hidden"></div>
            <div id="auth-loading" class="loading hidden">
                <i class="fas fa-spinner fa-spin"></i>
                Signing in...
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-container" class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-brand">
                    <i class="fas fa-stream"></i>
                    <h1>Buildkite Pipeline Builder</h1>
                    <span class="version">Enhanced v2.0</span>
                </div>
                <div class="header-actions">
                    <button id="load-example" class="btn btn-secondary">
                        <i class="fas fa-file-import"></i>
                        Load Example
                    </button>
                    <button id="clear-pipeline" class="btn btn-secondary">
                        <i class="fas fa-trash"></i>
                        Clear All
                    </button>
                    <button id="export-yaml" class="btn btn-primary">
                        <i class="fas fa-download"></i>
                        Export YAML
                    </button>
                    <div class="user-menu hidden">
                        <button class="user-avatar">
                            <img id="user-photo" src="" alt="User" />
                        </button>
                        <div class="user-dropdown">
                            <div class="user-info">
                                <span id="user-name"></span>
                                <small id="user-email"></small>
                            </div>
                            <hr>
                            <button id="sign-out-btn" class="dropdown-item">
                                <i class="fas fa-sign-out-alt"></i>
                                Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Enhanced Sidebar -->
            <aside class="enhanced-sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-toolbox"></i> Step Types</h3>
                    <p>Drag steps to build your pipeline</p>
                </div>

                <!-- Core Steps -->
                <div class="step-category">
                    <h4><i class="fas fa-star"></i> Core Steps</h4>
                    <div class="step-type" draggable="true" data-step-type="command">
                        <i class="fas fa-terminal"></i>
                        <span>Command Step</span>
                        <small>Execute shell commands</small>
                    </div>
                    <div class="step-type" draggable="true" data-step-type="wait">
                        <i class="fas fa-hourglass-half"></i>
                        <span>Wait Step</span>
                        <small>Wait for dependencies</small>
                    </div>
                    <div class="step-type" draggable="true" data-step-type="block">
                        <i class="fas fa-hand-paper"></i>
                        <span>Block Step</span>
                        <small>Manual approval</small>
                    </div>
                    <div class="step-type" draggable="true" data-step-type="input">
                        <i class="fas fa-keyboard"></i>
                        <span>Input Step</span>
                        <small>Collect user input</small>
                    </div>
                </div>

                <!-- Advanced Steps -->
                <div class="step-category">
                    <h4><i class="fas fa-cogs"></i> Advanced Steps</h4>
                    <div class="step-type" draggable="true" data-step-type="trigger">
                        <i class="fas fa-play"></i>
                        <span>Trigger Step</span>
                        <small>Trigger other pipelines</small>
                    </div>
                    <div class="step-type" draggable="true" data-step-type="group">
                        <i class="fas fa-layer-group"></i>
                        <span>Group Step</span>
                        <small>Organize related steps</small>
                    </div>
                    <div class="step-type" draggable="true" data-step-type="annotation">
                        <i class="fas fa-sticky-note"></i>
                        <span>Annotation</span>
                        <small>Build annotations</small>
                    </div>
                    <div class="step-type" draggable="true" data-step-type="plugin">
                        <i class="fas fa-plug"></i>
                        <span>Plugin Step</span>
                        <small>Use Buildkite plugins</small>
                    </div>
                </div>

                <!-- Utility Steps -->
                <div class="step-category">
                    <h4><i class="fas fa-tools"></i> Utility Steps</h4>
                    <div class="step-type" draggable="true" data-step-type="notify">
                        <i class="fas fa-bell"></i>
                        <span>Notify Step</span>
                        <small>Send notifications</small>
                    </div>
                    <div class="step-type" draggable="true" data-step-type="upload">
                        <i class="fas fa-upload"></i>
                        <span>Pipeline Upload</span>
                        <small>Dynamic pipeline generation</small>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h4><i class="fas fa-bolt"></i> Quick Actions</h4>
                    <button class="quick-action" onclick="pipelineBuilder.showStepTemplates()">
                        <i class="fas fa-layer-group"></i>
                        <span>Templates</span>
                    </button>
                    <button class="quick-action" onclick="pipelineBuilder.showPluginCatalog()">
                        <i class="fas fa-plug"></i>
                        <span>Plugins</span>
                    </button>
                    <button class="quick-action" onclick="pipelineBuilder.showMatrixBuilder()">
                        <i class="fas fa-th"></i>
                        <span>Matrix</span>
                    </button>
                    <button class="quick-action" onclick="pipelineBuilder.showKeyboardShortcuts()">
                        <i class="fas fa-keyboard"></i>
                        <span>Shortcuts</span>
                    </button>
                    <button class="quick-action" onclick="window.dependencyGraph && window.dependencyGraph.showDependencyGraph()">
                        <i class="fas fa-project-diagram"></i>
                        <span>Dependencies</span>
                    </button>
                    <button class="quick-action" onclick="window.dependencyGraph && window.dependencyGraph.showConditionalBuilder()">
                        <i class="fas fa-code-branch"></i>
                        <span>Conditions</span>
                    </button>
                </div>

                <!-- Popular Plugins -->
                <div class="plugin-shortcuts">
                    <h4><i class="fas fa-fire"></i> Popular Plugins</h4>
                    <div class="plugin-grid">
                        <div class="plugin-quick" onclick="pipelineBuilder.addPluginStep('docker')">
                            <i class="fab fa-docker"></i>
                            <span>Docker</span>
                        </div>
                        <div class="plugin-quick" onclick="pipelineBuilder.addPluginStep('junit-annotate')">
                            <i class="fas fa-file-alt"></i>
                            <span>JUnit</span>
                        </div>
                        <div class="plugin-quick" onclick="pipelineBuilder.addPluginStep('ecr')">
                            <i class="fab fa-aws"></i>
                            <span>AWS ECR</span>
                        </div>
                        <div class="plugin-quick" onclick="pipelineBuilder.addPluginStep('artifacts')">
                            <i class="fas fa-box"></i>
                            <span>Artifacts</span>
                        </div>
                    </div>
                </div>

                <!-- Help Links -->
                <div class="help-links">
                    <a href="https://buildkite.com/docs/pipelines" target="_blank" class="help-link">
                        <i class="fas fa-book"></i>
                        Pipeline Documentation
                    </a>
                    <a href="https://buildkite.com/docs/plugins" target="_blank" class="help-link">
                        <i class="fas fa-plug"></i>
                        Plugin Directory
                    </a>
                    <a href="https://buildkite.com/docs/pipelines/command-step" target="_blank" class="help-link">
                        <i class="fas fa-question-circle"></i>
                        Step Reference
                    </a>
                </div>
            </aside>

            <!-- Pipeline Canvas -->
            <div class="pipeline-canvas">
                <div class="canvas-header">
                    <h2><i class="fas fa-stream"></i> Pipeline Steps</h2>
                    <div class="canvas-actions">
                        <button class="btn btn-secondary btn-small" title="Keyboard Shortcuts" onclick="pipelineBuilder.showKeyboardShortcuts()">
                            <i class="fas fa-keyboard"></i>
                        </button>
                        <button class="btn btn-secondary btn-small" title="Validate Pipeline" onclick="pipelineBuilder.validatePipeline()">
                            <i class="fas fa-check-circle"></i>
                        </button>
                        <button class="btn btn-secondary btn-small" title="Dependency Graph" onclick="window.dependencyGraph && window.dependencyGraph.showDependencyGraph()">
                            <i class="fas fa-project-diagram"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Enhanced Drop Zone -->
                <div id="pipeline-steps" class="pipeline-steps-container">
                    <div class="empty-pipeline">
                        <i class="fas fa-stream"></i>
                        <h3>Start Building Your Pipeline</h3>
                        <p>Drag step types from the sidebar to build your pipeline</p>
                        <div class="empty-actions">
                            <button class="btn btn-primary" onclick="pipelineBuilder.loadExample()">
                                <i class="fas fa-play"></i>
                                Load Example Pipeline
                            </button>
                            <button class="btn btn-secondary" onclick="pipelineBuilder.showStepTemplates()">
                                <i class="fas fa-layer-group"></i>
                                Browse Templates
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Properties Panel -->
            <aside class="properties-panel">
                <div class="properties-header">
                    <h3><i class="fas fa-cog"></i> Step Properties</h3>
                    <div class="properties-actions">
                        <button class="btn btn-secondary btn-small" title="Reset to Defaults" onclick="pipelineBuilder.resetStepProperties()">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="btn btn-secondary btn-small" title="Advanced Settings" onclick="window.dependencyGraph && window.dependencyGraph.showConditionalBuilder()">
                            <i class="fas fa-cogs"></i>
                        </button>
                    </div>
                </div>
                <div id="properties-content">
                    <div class="no-selection">
                        <i class="fas fa-mouse-pointer"></i>
                        <p>Select a step to view and edit its properties</p>
                        <div class="selection-hints">
                            <div class="hint">
                                <i class="fas fa-click"></i>
                                <span>Click any step to configure</span>
                            </div>
                            <div class="hint">
                                <i class="fas fa-arrows-alt"></i>
                                <span>Drag to reorder steps</span>
                            </div>
                            <div class="hint">
                                <i class="fas fa-copy"></i>
                                <span>Use action buttons to duplicate</span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- ENHANCED MODALS -->

    <!-- YAML Export Modal -->
    <div id="yaml-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-code"></i> Generated Pipeline YAML</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="yaml-actions">
                    <button id="copy-yaml" class="btn btn-primary">
                        <i class="fas fa-copy"></i> Copy to Clipboard
                    </button>
                    <button id="download-yaml" class="btn btn-secondary">
                        <i class="fas fa-download"></i> Download File
                    </button>
                    <button class="btn btn-secondary" onclick="pipelineBuilder.validateYAML()">
                        <i class="fas fa-check-circle"></i> Validate
                    </button>
                </div>
                <textarea id="yaml-output" readonly></textarea>
                <div id="yaml-validation" class="validation-results hidden"></div>
            </div>
        </div>
    </div>

    <!-- Visual Dependency Graph Modal -->
    <div id="dependency-graph-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-project-diagram"></i> Pipeline Dependency Graph</h3>
                <button class="modal-close" data-modal="dependency-graph-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="graph-controls">
                    <div>
                        <button class="btn btn-secondary" data-action="reset-view">
                            <i class="fas fa-expand-arrows-alt"></i> Reset View
                        </button>
                        <button class="btn btn-secondary" data-action="auto-layout">
                            <i class="fas fa-magic"></i> Auto Layout
                        </button>
                        <button class="btn btn-secondary" data-action="export-graph">
                            <i class="fas fa-download"></i> Export SVG
                        </button>
                    </div>
                    <div class="graph-legend">
                        <span class="legend-item">
                            <div class="legend-color" style="background: #667eea;"></div>
                            Command Steps
                        </span>
                        <span class="legend-item">
                            <div class="legend-color" style="background: #f6ad55;"></div>
                            Wait Steps
                        </span>
                        <span class="legend-item">
                            <div class="legend-color" style="background: #e53e3e;"></div>
                            Block Steps
                        </span>
                    </div>
                </div>
                <canvas id="dependency-canvas" width="800" height="600"></canvas>
                <div class="graph-info">
                    <div id="node-details" class="node-details">
                        <h4>Select a step to view details</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Conditional Logic Builder Modal -->
    <div id="conditional-builder-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-code-branch"></i> Conditional Logic Builder</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="conditional-builder">
                    <div class="condition-groups" id="condition-groups">
                        <div class="condition-group">
                            <div class="condition-header">
                                <h4>IF Conditions</h4>
                                <button class="btn btn-secondary btn-small" data-action="add-condition" data-type="if">
                                    <i class="fas fa-plus"></i> Add Condition
                                </button>
                            </div>
                            <div id="if-conditions" class="conditions-list"></div>
                        </div>
                        
                        <div class="condition-group">
                            <div class="condition-header">
                                <h4>UNLESS Conditions</h4>
                                <button class="btn btn-secondary btn-small" data-action="add-condition" data-type="unless">
                                    <i class="fas fa-plus"></i> Add Condition
                                </button>
                            </div>
                            <div id="unless-conditions" class="conditions-list"></div>
                        </div>
                    </div>
                    
                    <div class="condition-preview">
                        <h4>Generated Condition</h4>
                        <pre id="condition-output"></pre>
                    </div>
                    
                    <div class="condition-templates">
                        <h4>Quick Templates</h4>
                        <div class="template-buttons">
                            <button class="btn btn-outline" data-template="main-branch">
                                Main Branch Only
                            </button>
                            <button class="btn btn-outline" data-template="pull-request">
                                Pull Request Only
                            </button>
                            <button class="btn btn-outline" data-template="file-changes">
                                File Changes
                            </button>
                            <button class="btn btn-outline" data-template="env-var">
                                Environment Variable
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" data-modal="conditional-builder-modal">Cancel</button>
                <button class="btn btn-primary" data-action="apply-conditions">Apply Conditions</button>
            </div>
        </div>
    </div>

    <!-- Enhanced Dependency Manager Modal -->
    <div id="dependency-manager-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-sitemap"></i> Dependency Manager</h3>
                <button class="modal-close" data-modal="dependency-manager-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="dependency-manager">
                    <div class="dependency-types">
                        <h4>Dependency Types</h4>
                        <div class="dependency-type-buttons">
                            <button class="btn btn-outline dependency-type-btn active" data-type="explicit">
                                <i class="fas fa-link"></i> Explicit Dependencies
                            </button>
                            <button class="btn btn-outline dependency-type-btn" data-type="file-based">
                                <i class="fas fa-file"></i> File-Based Dependencies
                            </button>
                            <button class="btn btn-outline dependency-type-btn" data-type="conditional">
                                <i class="fas fa-code-branch"></i> Conditional Dependencies
                            </button>
                        </div>
                    </div>
                    
                    <div class="dependency-content">
                        <div id="explicit-dependencies" class="dependency-section">
                            <div class="step-dependencies">
                                <h5>Step Dependencies</h5>
                                <div id="step-dependency-list"></div>
                            </div>
                        </div>
                        
                        <div id="file-based-dependencies" class="dependency-section" style="display: none;">
                            <div class="file-pattern-dependencies">
                                <h5>File Pattern Dependencies</h5>
                                <div class="dependency-controls">
                                    <div class="property-group">
                                        <label>File Pattern</label>
                                        <input type="text" placeholder="src/**/*.js" />
                                    </div>
                                    <div class="property-group">
                                        <label>Action</label>
                                        <select>
                                            <option value="skip">Skip if no changes</option>
                                            <option value="run">Run if changes</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="conditional-dependencies" class="dependency-section" style="display: none;">
                            <div class="conditional-dependency-builder">
                                <h5>Conditional Dependencies</h5>
                                <div class="conditional-rules">
                                    <div class="property-group">
                                        <label>Condition Type</label>
                                        <select class="condition-type">
                                            <option value="branch">Branch Pattern</option>
                                            <option value="env">Environment Variable</option>
                                            <option value="metadata">Build Metadata</option>
                                            <option value="time">Time-based</option>
                                        </select>
                                    </div>
                                    <div class="property-group">
                                        <label>Rule</label>
                                        <input type="text" placeholder="main develop/*" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" data-modal="dependency-manager-modal">Cancel</button>
                <button class="btn btn-primary" data-action="apply-dependencies">Apply Dependencies</button>
            </div>
        </div>
    </div>

    <!-- Plugin Catalog Modal -->
    <div id="plugin-catalog-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-plug"></i> Plugin Catalog</h3>
                <button class="modal-close" data-modal="plugin-catalog-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="plugin-catalog">
                    <!-- Search and Filters -->
                    <div class="plugin-search">
                        <input type="text" placeholder="Search plugins..." class="search-input">
                        <div class="plugin-categories">
                            <button class="category-filter active" data-category="all">All</button>
                            <button class="category-filter" data-category="docker">Docker</button>
                            <button class="category-filter" data-category="testing">Testing</button>
                            <button class="category-filter" data-category="deployment">Deployment</button>
                            <button class="category-filter" data-category="notification">Notification</button>
                        </div>
                    </div>
                    <div id="plugin-catalog-content" class="plugin-catalog-grid">
                        <!-- Plugin cards will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Matrix Builder Modal -->
    <div id="matrix-builder-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-th"></i> Matrix Builder</h3>
                <button class="modal-close" onclick="this.closest('.modal').classList.add('hidden')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p class="matrix-description">
                    Create a matrix to run the same step with different configurations in parallel.
                </p>
                <div class="matrix-builder-content">
                    <!-- Left Panel: Matrix Dimensions Editor -->
                    <div class="matrix-dimensions">
                        <h4><i class="fas fa-cogs"></i> Matrix Dimensions</h4>
                        <div id="matrix-dimensions-list" class="matrix-dimensions-list">
                            <!-- Matrix dimensions will be added here dynamically -->
                        </div>
                        <button class="btn btn-secondary btn-small" id="add-matrix-dimension">
                            <i class="fas fa-plus"></i> Add Dimension
                        </button>
                    </div>
                    
                    <!-- Right Panel: Live Preview -->
                    <div class="matrix-preview-section">
                        <h4><i class="fas fa-eye"></i> Matrix Preview</h4>
                        <div id="matrix-live-preview" class="matrix-live-preview">
                            <div class="empty-state">
                                <i class="fas fa-cube"></i>
                                <p>Add matrix dimensions to see preview</p>
                            </div>
                        </div>
                        
                        <div class="matrix-stats" id="matrix-stats" style="display: none;">
                            <div class="stat-item">
                                <span class="stat-label">Total Jobs:</span>
                                <span class="stat-value" id="total-jobs">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Dimensions:</span>
                                <span class="stat-value" id="dimension-count">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Matrix Presets Section -->
                <div class="matrix-presets">
                    <h4><i class="fas fa-templates"></i> Quick Presets</h4>
                    <div class="preset-buttons" id="matrix-preset-buttons">
                        <!-- Preset buttons will be populated dynamically -->
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="this.closest('.modal').classList.add('hidden')">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="pipelineBuilder.applyMatrixToStep()">
                    <i class="fas fa-check"></i>
                    Apply Matrix
                </button>
            </div>
        </div>
    </div>

    <!-- Step Templates Modal -->
    <div id="templates-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-layer-group"></i> Step Templates</h3>
                <button class="modal-close" onclick="this.closest('.modal').classList.add('hidden')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="template-categories">
                    <button class="category-filter active" data-category="all">All Templates</button>
                    <button class="category-filter" data-category="testing">Testing</button>
                    <button class="category-filter" data-category="deployment">Deployment</button>
                    <button class="category-filter" data-category="docker">Docker</button>
                    <button class="category-filter" data-category="notification">Notification</button>
                </div>
                <div id="templates-content" class="template-grid">
                    <!-- Template cards will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h3>
                <button class="modal-close" onclick="this.closest('.modal').classList.add('hidden')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-grid">
                    <div class="shortcut-category">
                        <h4>Pipeline Actions</h4>
                        <div class="shortcut-item">
                            <span>Export YAML</span>
                            <div><kbd>Ctrl</kbd> + <kbd>S</kbd></div>
                        </div>
                        <div class="shortcut-item">
                            <span>Clear Pipeline</span>
                            <div><kbd>Ctrl</kbd> + <kbd>N</kbd></div>
                        </div>
                        <div class="shortcut-item">
                            <span>Load Example</span>
                            <div><kbd>Ctrl</kbd> + <kbd>E</kbd></div>
                        </div>
                    </div>
                    <div class="shortcut-category">
                        <h4>Step Management</h4>
                        <div class="shortcut-item">
                            <span>Delete Selected Step</span>
                            <div><kbd>Delete</kbd></div>
                        </div>
                        <div class="shortcut-item">
                            <span>Deselect Step</span>
                            <div><kbd>Escape</kbd></div>
                        </div>
                    </div>
                    <div class="shortcut-category">
                        <h4>Quick Tools</h4>
                        <div class="shortcut-item">
                            <span>Plugin Catalog</span>
                            <div><kbd>Ctrl</kbd> + <kbd>P</kbd></div>
                        </div>
                        <div class="shortcut-item">
                            <span>Matrix Builder</span>
                            <div><kbd>Ctrl</kbd> + <kbd>M</kbd></div>
                        </div>
                        <div class="shortcut-item">
                            <span>Step Templates</span>
                            <div><kbd>Ctrl</kbd> + <kbd>T</kbd></div>
                        </div>
                        <div class="shortcut-item">
                            <span>Dependency Graph</span>
                            <div><kbd>Ctrl</kbd> + <kbd>D</kbd></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pipeline Validation Modal -->
    <div id="validation-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-check-circle"></i> Pipeline Validation</h3>
                <button class="modal-close" onclick="this.closest('.modal').classList.add('hidden')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="validation-results">
                    <div class="validation-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Validating pipeline...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/pipeline-builder.js"></script>
    <script src="js/yaml-generator.js"></script>
    <script src="js/firebase-auth.js"></script>
    <script src="js/dependency-graph.js"></script>
    <script src="js/main-init.js"></script>
    <script src="js/app.js"></script>

    <!-- Initialize Application -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Buildkite Pipeline Builder Loading...');
            
            // Initialize Firebase Auth if available
            if (typeof initializeFirebaseAuth === 'function') {
                initializeFirebaseAuth().then(() => {
                    console.log('🔐 Firebase Auth initialized');
                }).catch(error => {
                    console.warn('⚠️ Firebase Auth not available:', error.message);
                    // Show app without auth
                    document.getElementById('app-container').classList.remove('hidden');
                });
            } else {
                // No auth required, show app immediately
                document.getElementById('app-container').classList.remove('hidden');
            }

            // Initialize modal management
            setupModalManagement();
            
            // Setup global keyboard shortcuts
            setupGlobalKeyboardShortcuts();
            
            console.log('✅ Application initialized successfully');
        });

        function setupModalManagement() {
            // Close modals when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.add('hidden');
                }
            });

            // Close modals with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal:not(.hidden)');
                    if (openModal) {
                        openModal.classList.add('hidden');
                    }
                }
            });
            
            // Handle modal close buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-close')) {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                }
                
                // Handle data-modal close buttons
                if (e.target.dataset.modal) {
                    const modalId = e.target.dataset.modal;
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                }
            });
        }

        function setupGlobalKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            if (window.pipelineBuilder) {
                                window.pipelineBuilder.exportYAML();
                            }
                            break;
                        case 'n':
                            e.preventDefault();
                            if (window.pipelineBuilder) {
                                window.pipelineBuilder.clearPipeline();
                            }
                            break;
                        case 'e':
                            e.preventDefault();
                            if (window.pipelineBuilder) {
                                window.pipelineBuilder.loadExample();
                            }
                            break;
                        case 'p':
                            e.preventDefault();
                            if (window.pipelineBuilder) {
                                window.pipelineBuilder.showPluginCatalog();
                            }
                            break;
                        case 'm':
                            e.preventDefault();
                            if (window.pipelineBuilder) {
                                window.pipelineBuilder.showMatrixBuilder();
                            }
                            break;
                        case 't':
                            e.preventDefault();
                            if (window.pipelineBuilder) {
                                window.pipelineBuilder.showStepTemplates();
                            }
                            break;
                        case 'd':
                            e.preventDefault();
                            if (window.dependencyGraph) {
                                window.dependencyGraph.showDependencyGraph();
                            }
                            break;
                    }
                }
            });
        }
    </script>
</body>
</html>