<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buildkite Pipeline Builder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Main Application -->
    <div id="app-container" class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-brand">
                    <i class="fas fa-stream"></i>
                    <h1>Buildkite Pipeline Builder</h1>
                    <span class="version">Enhanced v2.0</span>
                </div>
                <div class="header-actions">
                    <button id="load-example" class="btn btn-secondary">
                        <i class="fas fa-file-import"></i>
                        Load Example
                    </button>
                    <button id="clear-pipeline" class="btn btn-secondary">
                        <i class="fas fa-trash"></i>
                        Clear All
                    </button>
                    <button id="export-yaml" class="btn btn-primary">
                        <i class="fas fa-download"></i>
                        Export YAML
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Enhanced Sidebar -->
            <aside class="enhanced-sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-toolbox"></i> Step Types</h3>
                    <p>Drag steps to build your pipeline</p>
                </div>

                <!-- Core Steps -->
                <div class="step-category">
                    <h4><i class="fas fa-star"></i> Core Steps</h4>
                    <div class="step-type" draggable="true" data-step-type="command">
                        <i class="fas fa-terminal"></i>
                        <span>Command Step</span>
                        <small>Execute shell commands</small>
                    </div>
                    <div class="step-type" draggable="true" data-step-type="wait">
                        <i class="fas fa-hourglass-half"></i>
                        <span>Wait Step</span>
                        <small>Wait for dependencies</small>
                    </div>
                    <div class="step-type" draggable="true" data-step-type="block">
                        <i class="fas fa-hand-paper"></i>
                        <span>Block Step</span>
                        <small>Manual approval</small>
                    </div>
                    <div class="step-type" draggable="true" data-step-type="input">
                        <i class="fas fa-keyboard"></i>
                        <span>Input Step</span>
                        <small>Collect user input</small>
                    </div>
                </div>

                <!-- Advanced Steps -->
                <div class="step-category">
                    <h4><i class="fas fa-cogs"></i> Advanced Steps</h4>
                    <div class="step-type" draggable="true" data-step-type="trigger">
                        <i class="fas fa-play"></i>
                        <span>Trigger Step</span>
                        <small>Trigger another pipeline</small>
                    </div>
                    <div class="step-type" draggable="true" data-step-type="group">
                        <i class="fas fa-layer-group"></i>
                        <span>Group Step</span>
                        <small>Group related steps</small>
                    </div>
                </div>

                <!-- Plugin Steps -->
                <div class="step-category">
                    <h4><i class="fas fa-puzzle-piece"></i> Popular Plugins</h4>
                    <div class="step-type" draggable="true" data-step-type="plugin" data-plugin="docker">
                        <i class="fab fa-docker"></i>
                        <span>Docker</span>
                        <small>Docker build & push</small>
                    </div>
                    <div class="step-type" draggable="true" data-step-type="plugin" data-plugin="artifacts">
                        <i class="fas fa-archive"></i>
                        <span>Artifacts</span>
                        <small>Upload/download artifacts</small>
                    </div>
                    <div class="step-type" draggable="true" data-step-type="plugin" data-plugin="junit">
                        <i class="fas fa-flask"></i>
                        <span>JUnit</span>
                        <small>Test result annotation</small>
                    </div>
                    <div class="step-type" draggable="true" data-step-type="plugin" data-plugin="slack">
                        <i class="fab fa-slack"></i>
                        <span>Slack</span>
                        <small>Send notifications</small>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="sidebar-actions">
                    <button id="open-plugin-catalog" class="btn btn-secondary btn-full">
                        <i class="fas fa-store"></i>
                        Plugin Catalog
                    </button>
                    <button id="open-templates" class="btn btn-secondary btn-full">
                        <i class="fas fa-layer-group"></i>
                        Step Templates
                    </button>
                    <button id="show-shortcuts" class="btn btn-secondary btn-full">
                        <i class="fas fa-keyboard"></i>
                        Shortcuts
                    </button>
                </div>
            </aside>

            <!-- Pipeline Builder Area -->
            <section class="pipeline-builder">
                <div class="builder-header">
                    <div class="pipeline-info">
                        <h2><i class="fas fa-stream"></i> Pipeline Steps</h2>
                        <div class="pipeline-stats">
                            <span class="stat-item">
                                <i class="fas fa-list"></i>
                                <span id="step-count">0</span> steps
                            </span>
                            <span class="stat-item">
                                <i class="fas fa-clock"></i>
                                Last saved: <span id="last-saved">Never</span>
                            </span>
                        </div>
                    </div>
                    <div class="builder-actions">
                        <button id="validate-pipeline" class="btn btn-secondary">
                            <i class="fas fa-check-circle"></i>
                            Validate
                        </button>
                        <button id="preview-yaml" class="btn btn-secondary">
                            <i class="fas fa-eye"></i>
                            Preview
                        </button>
                    </div>
                </div>

                <!-- Drop Zone -->
                <div id="pipeline-steps" class="pipeline-steps">
                    <div class="empty-state" id="empty-state">
                        <div class="empty-state-content">
                            <i class="fas fa-mouse-pointer"></i>
                            <h3>Start Building Your Pipeline</h3>
                            <p>Drag step types from the sidebar to create your Buildkite pipeline</p>
                            <div class="empty-state-tips">
                                <div class="tip">
                                    <i class="fas fa-lightbulb"></i>
                                    <span>Tip: Use <kbd>Ctrl+K</kbd> to open the command palette</span>
                                </div>
                                <div class="tip">
                                    <i class="fas fa-lightning-bolt"></i>
                                    <span>Or try loading an example pipeline to get started</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Floating Action Button -->
                <div class="fab-container">
                    <button id="add-step-fab" class="fab" title="Add Step">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </section>
        </main>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <span class="status-item">
                    <i class="fas fa-circle status-indicator"></i>
                    Ready
                </span>
            </div>
            <div class="status-right">
                <span class="status-item">
                    <i class="fas fa-save"></i>
                    Auto-save enabled
                </span>
                <span class="status-item">
                    <i class="fas fa-code-branch"></i>
                    Pipeline Builder v2.0
                </span>
            </div>
        </div>
    </div>

    <!-- Step Configuration Modal -->
    <div id="step-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="step-modal-title"><i class="fas fa-cog"></i> Configure Step</h3>
                <button class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="step-config-form">
                    <!-- Step configuration form will be populated here -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="this.closest('.modal').classList.add('hidden')">
                    Cancel
                </button>
                <button id="save-step" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Save Step
                </button>
            </div>
        </div>
    </div>

    <!-- Plugin Catalog Modal -->
    <div id="plugin-catalog-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-store"></i> Plugin Catalog</h3>
                <button class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="plugin-catalog">
                    <div class="catalog-sidebar">
                        <div class="search-box">
                            <input type="text" id="plugin-search" placeholder="Search plugins...">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="category-list">
                            <button class="category-item active" data-category="all">
                                <i class="fas fa-globe"></i>
                                All Plugins
                            </button>
                            <button class="category-item" data-category="testing">
                                <i class="fas fa-flask"></i>
                                Testing
                            </button>
                            <button class="category-item" data-category="docker">
                                <i class="fab fa-docker"></i>
                                Docker
                            </button>
                            <button class="category-item" data-category="deployment">
                                <i class="fas fa-rocket"></i>
                                Deployment
                            </button>
                            <button class="category-item" data-category="notification">
                                <i class="fas fa-bell"></i>
                                Notifications
                            </button>
                            <button class="category-item" data-category="security">
                                <i class="fas fa-shield-alt"></i>
                                Security
                            </button>
                        </div>
                    </div>
                    <div class="catalog-content">
                        <div id="plugin-list" class="plugin-grid">
                            <!-- Plugin cards will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- YAML Export Modal -->
    <div id="yaml-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-file-code"></i> Pipeline YAML</h3>
                <button class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="yaml-export-controls">
                    <div class="export-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="include-comments" checked>
                            <span class="checkmark"></span>
                            Include comments
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="validate-yaml" checked>
                            <span class="checkmark"></span>
                            Validate YAML
                        </label>
                    </div>
                    <div class="export-actions">
                        <button class="btn btn-secondary" id="copy-yaml">
                            <i class="fas fa-copy"></i>
                            Copy to Clipboard
                        </button>
                        <button class="btn btn-secondary" id="download-yaml">
                            <i class="fas fa-download"></i>
                            Download File
                        </button>
                    </div>
                </div>
                <textarea id="yaml-output" readonly placeholder="Your pipeline YAML will appear here..."></textarea>
                <div id="yaml-validation" class="validation-results hidden">
                    <!-- Validation results will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Matrix Builder Modal -->
    <div id="matrix-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-th"></i> Build Matrix Configuration</h3>
                <button class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p class="modal-description">
                    <i class="fas fa-info-circle"></i>
                    Configure build matrix to run your step with different combinations of parameters.
                </p>
                <div class="matrix-builder-content">
                    <!-- Left Panel: Matrix Dimensions Editor -->
                    <div class="matrix-dimensions">
                        <h4><i class="fas fa-cogs"></i> Matrix Dimensions</h4>
                        <div id="matrix-dimensions-list" class="matrix-dimensions-list">
                            <!-- Matrix dimensions will be added here dynamically -->
                        </div>
                        <button class="btn btn-secondary btn-small" id="add-matrix-dimension">
                            <i class="fas fa-plus"></i> Add Dimension
                        </button>
                    </div>
                    
                    <!-- Right Panel: Live Preview -->
                    <div class="matrix-preview-section">
                        <h4><i class="fas fa-eye"></i> Matrix Preview</h4>
                        <div id="matrix-live-preview" class="matrix-live-preview">
                            <div class="empty-state">
                                <i class="fas fa-cube"></i>
                                <p>Add matrix dimensions to see preview</p>
                            </div>
                        </div>
                        
                        <div class="matrix-stats" id="matrix-stats" style="display: none;">
                            <div class="stat-item">
                                <span class="stat-label">Total Jobs:</span>
                                <span class="stat-value" id="total-jobs">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Dimensions:</span>
                                <span class="stat-value" id="dimension-count">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Matrix Presets Section -->
                <div class="matrix-presets">
                    <h4><i class="fas fa-templates"></i> Quick Presets</h4>
                    <div class="preset-buttons" id="matrix-preset-buttons">
                        <!-- Preset buttons will be populated dynamically -->
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="this.closest('.modal').classList.add('hidden')">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="pipelineBuilder.applyMatrixToStep()">
                    <i class="fas fa-check"></i>
                    Apply Matrix
                </button>
            </div>
        </div>
    </div>

    <!-- Step Templates Modal -->
    <div id="templates-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-layer-group"></i> Step Templates</h3>
                <button class="modal-close" onclick="this.closest('.modal').classList.add('hidden')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="template-categories">
                    <button class="category-filter active" data-category="all">All Templates</button>
                    <button class="category-filter" data-category="testing">Testing</button>
                    <button class="category-filter" data-category="deployment">Deployment</button>
                    <button class="category-filter" data-category="docker">Docker</button>
                    <button class="category-filter" data-category="notification">Notification</button>
                </div>
                <div id="templates-content" class="template-grid">
                    <!-- Template cards will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h3>
                <button class="modal-close" onclick="this.closest('.modal').classList.add('hidden')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-grid">
                    <div class="shortcut-section">
                        <h4>General</h4>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>K</kbd>
                            <span>Open command palette</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>S</kbd>
                            <span>Save pipeline</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>E</kbd>
                            <span>Export YAML</span>
                        </div>
                    </div>
                    <div class="shortcut-section">
                        <h4>Steps</h4>
                        <div class="shortcut-item">
                            <kbd>A</kbd>
                            <span>Add new step</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>D</kbd>
                            <span>Duplicate selected step</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Del</kbd>
                            <span>Delete selected step</span>
                        </div>
                    </div>
                    <div class="shortcut-section">
                        <h4>Navigation</h4>
                        <div class="shortcut-item">
                            <kbd>↑</kbd> / <kbd>↓</kbd>
                            <span>Navigate steps</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Enter</kbd>
                            <span>Edit selected step</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Esc</kbd>
                            <span>Close modal</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Command Palette -->
    <div id="command-palette" class="command-palette hidden">
        <div class="command-palette-content">
            <div class="command-search">
                <i class="fas fa-search"></i>
                <input type="text" id="command-input" placeholder="Type a command...">
            </div>
            <div id="command-results" class="command-results">
                <!-- Command results will be populated here -->
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/yaml-generator.js"></script>
    <script src="js/pipeline-builder.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        // Initialize application without authentication
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Buildkite Pipeline Builder - Starting initialization...');
            
            // Show app immediately (no authentication required)
            document.getElementById('app-container').classList.remove('hidden');

            // Initialize modal management
            setupModalManagement();
            
            // Setup global keyboard shortcuts
            setupGlobalKeyboardShortcuts();
            
            console.log('✅ Application initialized successfully (No Authentication)');
        });

        function setupModalManagement() {
            // Close modals when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.add('hidden');
                }
            });

            // Close modals with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal:not(.hidden)');
                    if (openModal) {
                        openModal.classList.add('hidden');
                    }
                }
            });
            
            // Handle modal close buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-close')) {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                }
                
                // Handle data-modal close buttons
                if (e.target.dataset.modal) {
                    const modalId = e.target.dataset.modal;
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                }
            });
        }

        function setupGlobalKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+K - Command palette
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    toggleCommandPalette();
                }
                
                // Ctrl+S - Save pipeline
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (typeof pipelineBuilder !== 'undefined') {
                        pipelineBuilder.savePipeline();
                    }
                }
                
                // Ctrl+E - Export YAML
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    document.getElementById('export-yaml').click();
                }
                
                // A - Add step (when no input focused)
                if (e.key === 'a' && !isInputFocused()) {
                    e.preventDefault();
                    document.getElementById('add-step-fab').click();
                }
                
                // ? - Show shortcuts
                if (e.key === '?' && !isInputFocused()) {
                    e.preventDefault();
                    document.getElementById('shortcuts-modal').classList.remove('hidden');
                }
            });
        }

        function isInputFocused() {
            const activeElement = document.activeElement;
            return activeElement && (
                activeElement.tagName === 'INPUT' || 
                activeElement.tagName === 'TEXTAREA' || 
                activeElement.contentEditable === 'true'
            );
        }

        function toggleCommandPalette() {
            const palette = document.getElementById('command-palette');
            if (palette.classList.contains('hidden')) {
                palette.classList.remove('hidden');
                document.getElementById('command-input').focus();
            } else {
                palette.classList.add('hidden');
            }
        }
    </script>
</body>
</html>