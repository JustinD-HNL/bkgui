<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buildkite Pipeline Builder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Main Application -->
    <div id="app-container" class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-brand">
                    <i class="fas fa-stream"></i>
                    <h1>Buildkite Pipeline Builder</h1>
                    <span class="version">Enhanced v2.0</span>
                </div>
                <div class="header-actions">
                    <button id="load-example" class="btn btn-secondary">
                        <i class="fas fa-file-import"></i>
                        Load Example
                    </button>
                    <button id="clear-pipeline" class="btn btn-secondary">
                        <i class="fas fa-trash"></i>
                        Clear All
                    </button>
                    <button id="export-yaml" class="btn btn-primary">
                        <i class="fas fa-download"></i>
                        Export YAML
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content - 3 Column Layout -->
        <main class="main-content">
            <!-- Enhanced Sidebar -->
            <aside class="sidebar enhanced-sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-toolbox"></i> Step Types</h3>
                    <p>Drag steps to build your pipeline</p>
                </div>

                <!-- Core Steps -->
                <div class="step-category">
                    <h4><i class="fas fa-star"></i> Core Steps</h4>
                    <div class="step-palette">
                        <div class="step-type" draggable="true" data-step-type="command">
                            <i class="fas fa-terminal"></i>
                            <span>Command Step</span>
                            <small>Execute shell commands</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="wait">
                            <i class="fas fa-hourglass-half"></i>
                            <span>Wait Step</span>
                            <small>Wait for dependencies</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="block">
                            <i class="fas fa-hand-paper"></i>
                            <span>Block Step</span>
                            <small>Manual approval</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="input">
                            <i class="fas fa-keyboard"></i>
                            <span>Input Step</span>
                            <small>Collect user input</small>
                        </div>
                    </div>
                </div>

                <!-- Advanced Steps -->
                <div class="step-category">
                    <h4><i class="fas fa-cogs"></i> Advanced Steps</h4>
                    <div class="step-palette">
                        <div class="step-type" draggable="true" data-step-type="trigger">
                            <i class="fas fa-play"></i>
                            <span>Trigger Step</span>
                            <small>Trigger another pipeline</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="group">
                            <i class="fas fa-layer-group"></i>
                            <span>Group Step</span>
                            <small>Group related steps</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="annotation">
                            <i class="fas fa-sticky-note"></i>
                            <span>Annotation</span>
                            <small>Add build annotations</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="plugin">
                            <i class="fas fa-plug"></i>
                            <span>Plugin Step</span>
                            <small>Use Buildkite plugins</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="notify">
                            <i class="fas fa-bell"></i>
                            <span>Notify Step</span>
                            <small>Send notifications</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="upload">
                            <i class="fas fa-upload"></i>
                            <span>Pipeline Upload</span>
                            <small>Dynamic pipeline upload</small>
                        </div>
                    </div>
                </div>

                <!-- Quick Templates -->
                <div class="step-category">
                    <h4><i class="fas fa-magic"></i> Quick Templates</h4>
                    <div class="template-palette">
                        <div class="template-item" data-template="test-suite">
                            <i class="fas fa-vial"></i>
                            <span>Test Suite</span>
                            <small>Complete testing pipeline</small>
                        </div>
                        <div class="template-item" data-template="docker-build">
                            <i class="fab fa-docker"></i>
                            <span>Docker Build</span>
                            <small>Build & push Docker images</small>
                        </div>
                        <div class="template-item" data-template="deployment-pipeline">
                            <i class="fas fa-rocket"></i>
                            <span>Deployment</span>
                            <small>Staged deployment with approvals</small>
                        </div>
                    </div>
                </div>

                <!-- Pipeline Patterns -->
                <div class="step-category">
                    <h4><i class="fas fa-sitemap"></i> Pipeline Patterns</h4>
                    <div class="pattern-palette">
                        <div class="pattern-item" data-pattern="ci-cd-basic">
                            <i class="fas fa-code-branch"></i>
                            <span>Basic CI/CD</span>
                            <small>Standard workflow</small>
                        </div>
                        <div class="pattern-item" data-pattern="microservices">
                            <i class="fas fa-cubes"></i>
                            <span>Microservices</span>
                            <small>Parallel service builds</small>
                        </div>
                        <div class="pattern-item" data-pattern="matrix-testing">
                            <i class="fas fa-th"></i>
                            <span>Matrix Testing</span>
                            <small>Multi-environment tests</small>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="step-category">
                    <h4><i class="fas fa-bolt"></i> Quick Actions</h4>
                    <div class="quick-actions">
                        <button class="action-btn" data-action="plugin-catalog">
                            <i class="fas fa-store"></i>
                            <span>Plugin Catalog</span>
                        </button>
                        <button class="action-btn" data-action="matrix-builder">
                            <i class="fas fa-th"></i>
                            <span>Matrix Builder</span>
                        </button>
                        <button class="action-btn" data-action="step-templates">
                            <i class="fas fa-layer-group"></i>
                            <span>Step Templates</span>
                        </button>
                        <button class="action-btn" data-action="dependency-graph">
                            <i class="fas fa-project-diagram"></i>
                            <span>Dependencies</span>
                        </button>
                        <button class="action-btn" data-action="conditional-builder">
                            <i class="fas fa-code-branch"></i>
                            <span>Conditionals</span>
                        </button>
                        <button class="action-btn" data-action="pipeline-validator">
                            <i class="fas fa-check-circle"></i>
                            <span>Validator</span>
                        </button>
                    </div>
                </div>

                <!-- Plugin Quickstart -->
                <div class="step-category">
                    <h4><i class="fas fa-puzzle-piece"></i> Popular Plugins</h4>
                    <div class="plugin-quickstart">
                        <div class="plugin-quick" data-plugin="docker">
                            <i class="fab fa-docker"></i>
                            <span>Docker</span>
                        </div>
                        <div class="plugin-quick" data-plugin="junit-annotate">
                            <i class="fas fa-vial"></i>
                            <span>JUnit</span>
                        </div>
                        <div class="plugin-quick" data-plugin="artifacts">
                            <i class="fas fa-archive"></i>
                            <span>Artifacts</span>
                        </div>
                        <div class="plugin-quick" data-plugin="ecr">
                            <i class="fab fa-aws"></i>
                            <span>AWS ECR</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Pipeline Canvas -->
            <section class="pipeline-canvas">
                <div class="canvas-header">
                    <h2><i class="fas fa-stream"></i> Pipeline Steps</h2>
                    <div class="canvas-actions">
                        <button id="validate-pipeline" class="btn btn-secondary">
                            <i class="fas fa-check-circle"></i>
                            Validate
                        </button>
                    </div>
                </div>

                <!-- Enhanced Drop Zone -->
                <div id="pipeline-steps" class="pipeline-steps">
                    <div class="empty-pipeline">
                        <i class="fas fa-stream"></i>
                        <h3>Start Building Your Pipeline</h3>
                        <p>Drag step types from the sidebar to build your pipeline</p>
                    </div>
                </div>
            </section>

            <!-- Properties Panel -->
            <aside class="properties-panel">
                <h3><i class="fas fa-cog"></i> Step Properties</h3>
                <div id="properties-content">
                    <div class="no-selection">
                        <i class="fas fa-mouse-pointer"></i>
                        <p>Select a step to view and edit its properties</p>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- All Modals (keeping existing ones and adding missing ones) -->
    
    <!-- Plugin Catalog Modal -->
    <div id="plugin-catalog-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-store"></i> Plugin Catalog</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="plugin-catalog-content" class="plugin-catalog">
                    <!-- Plugin catalog will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Matrix Builder Modal -->
    <div id="matrix-builder-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-th"></i> Matrix Builder</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="matrix-builder">
                    <div class="matrix-dimensions" id="matrix-dimensions">
                        <div class="matrix-dimension">
                            <label>Dimension Name:</label>
                            <input type="text" class="dimension-name" placeholder="e.g., node_version" />
                            <label>Values (comma-separated):</label>
                            <input type="text" class="dimension-values" placeholder="e.g., 14, 16, 18" />
                            <button type="button" class="btn btn-secondary btn-small" onclick="this.parentElement.remove()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="window.pipelineBuilder && window.pipelineBuilder.addMatrixDimension && window.pipelineBuilder.addMatrixDimension()">
                        <i class="fas fa-plus"></i> Add Dimension
                    </button>
                    
                    <!-- Matrix Presets -->
                    <div class="matrix-presets">
                        <h4>Quick Presets</h4>
                        <div class="preset-buttons" id="matrix-preset-buttons">
                            <button class="btn btn-outline" onclick="window.pipelineBuilder && window.pipelineBuilder.applyMatrixPreset && window.pipelineBuilder.applyMatrixPreset('node-versions')">
                                Node.js Versions
                            </button>
                            <button class="btn btn-outline" onclick="window.pipelineBuilder && window.pipelineBuilder.applyMatrixPreset && window.pipelineBuilder.applyMatrixPreset('os-matrix')">
                                Operating Systems
                            </button>
                            <button class="btn btn-outline" onclick="window.pipelineBuilder && window.pipelineBuilder.applyMatrixPreset && window.pipelineBuilder.applyMatrixPreset('browser-matrix')">
                                Browser Testing
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary modal-close">Cancel</button>
                <button class="btn btn-primary" onclick="window.pipelineBuilder && window.pipelineBuilder.applyMatrixToStep && window.pipelineBuilder.applyMatrixToStep()">Apply Matrix</button>
            </div>
        </div>
    </div>

    <!-- Step Templates Modal -->
    <div id="templates-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-layer-group"></i> Step Templates</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="templates-content">
                    <!-- Templates will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Dependency Graph Modal -->
    <div id="dependency-graph-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-project-diagram"></i> Pipeline Dependency Graph</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="graph-controls">
                    <button class="btn btn-secondary" data-action="reset-view">
                        <i class="fas fa-expand-arrows-alt"></i> Reset View
                    </button>
                    <button class="btn btn-secondary" data-action="auto-layout">
                        <i class="fas fa-magic"></i> Auto Layout
                    </button>
                    <button class="btn btn-secondary" data-action="export-graph">
                        <i class="fas fa-download"></i> Export SVG
                    </button>
                </div>
                <canvas id="dependency-canvas" width="800" height="600"></canvas>
                <div class="graph-info">
                    <div id="node-details" class="node-details">
                        <h4>Select a step to view details</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Conditional Builder Modal -->
    <div id="conditional-builder-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-code-branch"></i> Conditional Logic Builder</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="conditional-builder">
                    <div class="condition-groups" id="condition-groups">
                        <div class="condition-group">
                            <div class="condition-header">
                                <h4>IF Conditions</h4>
                                <button class="btn btn-secondary btn-small" data-action="add-condition" data-type="if">
                                    <i class="fas fa-plus"></i> Add Condition
                                </button>
                            </div>
                            <div id="if-conditions" class="conditions-list"></div>
                        </div>
                        
                        <div class="condition-group">
                            <div class="condition-header">
                                <h4>UNLESS Conditions</h4>
                                <button class="btn btn-secondary btn-small" data-action="add-condition" data-type="unless">
                                    <i class="fas fa-plus"></i> Add Condition
                                </button>
                            </div>
                            <div id="unless-conditions" class="conditions-list"></div>
                        </div>
                    </div>
                    
                    <div class="condition-preview">
                        <h4>Generated Condition</h4>
                        <pre id="condition-output"></pre>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary modal-close">Cancel</button>
                <button class="btn btn-primary" data-action="apply-conditions">Apply Conditions</button>
            </div>
        </div>
    </div>

    <!-- Dependency Manager Modal -->
    <div id="dependency-manager-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-sitemap"></i> Dependency Manager</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="dependency-manager">
                    <div class="dependency-types">
                        <h4>Dependency Types</h4>
                        <div class="dependency-type-buttons">
                            <button class="btn btn-outline dependency-type-btn active" data-type="explicit">
                                <i class="fas fa-link"></i> Explicit Dependencies
                            </button>
                            <button class="btn btn-outline dependency-type-btn" data-type="file-based">
                                <i class="fas fa-file"></i> File-Based Dependencies
                            </button>
                            <button class="btn btn-outline dependency-type-btn" data-type="conditional">
                                <i class="fas fa-code-branch"></i> Conditional Dependencies
                            </button>
                        </div>
                    </div>
                    
                    <div class="dependency-content">
                        <div id="explicit-dependencies" class="dependency-section">
                            <div class="step-dependencies">
                                <h5>Step Dependencies</h5>
                                <div id="step-dependency-list"></div>
                            </div>
                        </div>
                        
                        <div id="file-based-dependencies" class="dependency-section" style="display: none;">
                            <div class="file-dependency-builder">
                                <h5>File Change Dependencies</h5>
                                <div class="file-patterns">
                                    <div class="property-group">
                                        <label>Watch Patterns</label>
                                        <textarea placeholder="src/**/*.js&#10;tests/**/*.test.js&#10;package.json"></textarea>
                                        <small>File patterns that trigger this step when changed</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="conditional-dependencies" class="dependency-section" style="display: none;">
                            <div class="conditional-dependency-builder">
                                <h5>Conditional Dependencies</h5>
                                <div class="conditional-rules">
                                    <div class="property-group">
                                        <label>Condition</label>
                                        <select class="condition-type">
                                            <option value="branch">Branch Pattern</option>
                                            <option value="env">Environment Variable</option>
                                            <option value="metadata">Build Metadata</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary modal-close">Cancel</button>
                <button class="btn btn-primary" data-action="apply-dependencies">Apply Dependencies</button>
            </div>
        </div>
    </div>

    <!-- YAML Export Modal -->
    <div id="yaml-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-file-code"></i> Pipeline YAML</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="yaml-controls">
                    <button class="btn btn-secondary" onclick="navigator.clipboard.writeText(document.getElementById('yaml-output').value); alert('YAML copied to clipboard!')">
                        <i class="fas fa-copy"></i> Copy YAML
                    </button>
                    <button class="btn btn-secondary" onclick="window.downloadYAML && window.downloadYAML()">
                        <i class="fas fa-download"></i> Download File
                    </button>
                </div>
                <textarea id="yaml-output" readonly></textarea>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-grid">
                    <div class="shortcut-section">
                        <h4>General</h4>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>S</kbd>
                            <span>Export YAML</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>N</kbd>
                            <span>Clear Pipeline</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>E</kbd>
                            <span>Load Example</span>
                        </div>
                    </div>
                    <div class="shortcut-section">
                        <h4>Advanced</h4>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>P</kbd>
                            <span>Plugin Catalog</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>M</kbd>
                            <span>Matrix Builder</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>G</kbd>
                            <span>Dependency Graph</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Loading Order -->
    <script src="js/yaml-generator.js"></script>
    <script src="js/pipeline-patterns.js"></script>
    <script src="js/dependency-graph.js"></script>
    <script src="js/enhanced-pipeline-builder.js"></script>
    <script src="js/pipeline-builder.js"></script>
    <script src="js/main-init.js"></script>
    <script src="js/app.js"></script>
</body>
</html>