<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buildkite Pipeline Builder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Main Application -->
    <div id="app-container" class="app-container">
        <!-- Header - FIXED: Title now properly positioned at top -->
        <header class="header">
            <div class="header-content">
                <div class="header-brand">
                    <i class="fas fa-stream"></i>
                    <h1>Buildkite Pipeline Builder</h1>
                    <span class="version">Enhanced v2.0</span>
                </div>
                <div class="header-actions">
                    <button id="load-example" class="btn btn-secondary">
                        <i class="fas fa-file-import"></i>
                        Load Example
                    </button>
                    <button id="clear-pipeline" class="btn btn-secondary">
                        <i class="fas fa-trash"></i>
                        Clear All
                    </button>
                    <button id="export-yaml" class="btn btn-primary">
                        <i class="fas fa-download"></i>
                        Export YAML
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content - 3 Column Layout - FIXED: Proper grid structure -->
        <main class="main-content">
            <!-- Enhanced Sidebar - Left Column -->
            <aside class="sidebar enhanced-sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-toolbox"></i> Step Types</h3>
                    <p>Drag steps to build your pipeline</p>
                </div>

                <!-- Core Steps -->
                <div class="step-category">
                    <h4><i class="fas fa-star"></i> Core Steps</h4>
                    <div class="step-palette">
                        <div class="step-type" draggable="true" data-step-type="command">
                            <i class="fas fa-terminal"></i>
                            <span>Command Step</span>
                            <small>Execute shell commands</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="wait">
                            <i class="fas fa-hourglass-half"></i>
                            <span>Wait Step</span>
                            <small>Wait for previous steps</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="block">
                            <i class="fas fa-hand-paper"></i>
                            <span>Block Step</span>
                            <small>Manual approval gate</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="input">
                            <i class="fas fa-keyboard"></i>
                            <span>Input Step</span>
                            <small>Collect user input</small>
                        </div>
                    </div>
                </div>

                <!-- Advanced Steps -->
                <div class="step-category">
                    <h4><i class="fas fa-cogs"></i> Advanced Steps</h4>
                    <div class="step-palette">
                        <div class="step-type" draggable="true" data-step-type="trigger">
                            <i class="fas fa-bolt"></i>
                            <span>Trigger Step</span>
                            <small>Trigger another pipeline</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="group">
                            <i class="fas fa-layer-group"></i>
                            <span>Group Step</span>
                            <small>Group related steps</small>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="sidebar-actions">
                    <h4><i class="fas fa-magic"></i> Quick Actions</h4>
                    <div class="quick-actions">
                        <button class="quick-action" data-action="step-templates">
                            <i class="fas fa-file-alt"></i>
                            <span>Templates</span>
                        </button>
                        <button class="quick-action" data-action="plugin-catalog">
                            <i class="fas fa-puzzle-piece"></i>
                            <span>Plugins</span>
                        </button>
                        <button class="quick-action" data-action="matrix-builder">
                            <i class="fas fa-th"></i>
                            <span>Matrix</span>
                        </button>
                        <button class="quick-action" data-action="dependency-graph">
                            <i class="fas fa-project-diagram"></i>
                            <span>Dependencies</span>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Pipeline Canvas - Center Column -->
            <section class="pipeline-canvas">
                <div class="canvas-header">
                    <h3><i class="fas fa-stream"></i> Pipeline Steps</h3>
                    <div class="step-count">
                        <span id="step-count">0</span> steps
                    </div>
                </div>
                
                <!-- Drop Zone for Empty State -->
                <div id="pipeline-steps" class="pipeline-steps">
                    <div id="empty-state" class="empty-pipeline">
                        <i class="fas fa-layer-group"></i>
                        <h3>Start Building Your Pipeline</h3>
                        <p>Drag step types from the sidebar or click Quick Actions to get started</p>
                        <button class="btn btn-primary" onclick="window.pipelineBuilder && window.pipelineBuilder.loadExample()">
                            <i class="fas fa-magic"></i> Load Example Pipeline
                        </button>
                    </div>
                </div>

                <!-- Pipeline Actions -->
                <div class="pipeline-actions">
                    <button class="btn btn-secondary" onclick="window.mainInitializer && window.mainInitializer.validatePipeline()">
                        <i class="fas fa-check-circle"></i> Validate Pipeline
                    </button>
                    <button class="btn btn-secondary" data-action="preview">
                        <i class="fas fa-eye"></i> Preview YAML
                    </button>
                </div>
            </section>

            <!-- Properties Panel - Right Column -->
            <aside class="properties-panel">
                <div class="properties-header">
                    <h3><i class="fas fa-sliders-h"></i> Step Properties</h3>
                </div>
                
                <div id="properties-content" class="properties-content">
                    <div class="no-selection">
                        <i class="fas fa-mouse-pointer"></i>
                        <h3>No Step Selected</h3>
                        <p>Click on a pipeline step to edit its properties</p>
                        
                        <div class="properties-help">
                            <h4>Quick Tips:</h4>
                            <ul>
                                <li>• Drag steps from the sidebar to add them</li>
                                <li>• Click steps to select and edit</li>
                                <li>• Use the action buttons to reorder or delete</li>
                                <li>• Set dependencies between steps</li>
                                <li>• Configure plugins for enhanced functionality</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Command Palette Modal -->
    <div id="command-palette" class="modal hidden">
        <div class="modal-content command-palette">
            <div class="command-palette-header">
                <i class="fas fa-terminal"></i>
                <input type="text" class="command-palette-input" placeholder="Type a command...">
                <button class="command-palette-close">&times;</button>
            </div>
            <div class="command-palette-results"></div>
        </div>
    </div>

    <!-- Step Templates Modal -->
    <div id="step-templates-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-alt"></i> Pipeline Templates</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="template-grid">
                    <div class="template-item" data-template="deployment-pipeline">
                        <i class="fas fa-rocket"></i>
                        <span>Deployment Pipeline</span>
                        <small>Build, test, and deploy application</small>
                    </div>
                    <div class="template-item" data-template="quality-gates">
                        <i class="fas fa-shield-alt"></i>
                        <span>Quality Gates</span>
                        <small>Multiple quality checks with gates</small>
                    </div>
                </div>
                
                <h4 style="margin-top: 2rem;"><i class="fas fa-shapes"></i> Common Patterns</h4>
                <div class="pattern-grid">
                    <div class="pattern-item" data-pattern="ci-cd-basic">
                        <i class="fas fa-infinity"></i>
                        <span>Basic CI/CD</span>
                        <small>Standard continuous integration flow</small>
                    </div>
                    <div class="pattern-item" data-pattern="microservices">
                        <i class="fas fa-cubes"></i>
                        <span>Microservices</span>
                        <small>Parallel service builds</small>
                    </div>
                    <div class="pattern-item" data-pattern="matrix-build">
                        <i class="fas fa-th"></i>
                        <span>Matrix Build</span>
                        <small>Build across multiple versions</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Plugin Catalog Modal -->
    <div id="plugin-catalog-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-puzzle-piece"></i> Plugin Catalog</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="plugin-search">
                    <input type="text" placeholder="Search plugins..." class="plugin-search-input">
                </div>
                
                <div class="plugin-quickstart">
                    <h4>Popular Plugins</h4>
                    <div class="plugin-quick-grid">
                        <button class="plugin-quick" data-plugin="docker">
                            <i class="fab fa-docker"></i> Docker
                        </button>
                        <button class="plugin-quick" data-plugin="docker-compose">
                            <i class="fab fa-docker"></i> Docker Compose
                        </button>
                        <button class="plugin-quick" data-plugin="junit-annotate">
                            <i class="fas fa-vial"></i> JUnit
                        </button>
                        <button class="plugin-quick" data-plugin="artifacts">
                            <i class="fas fa-archive"></i> Artifacts
                        </button>
                    </div>
                </div>
                
                <div class="plugin-catalog">
                    <!-- Plugin items will be dynamically loaded -->
                </div>
            </div>
        </div>
    </div>

    <!-- Matrix Builder Modal -->
    <div id="matrix-builder-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-th"></i> Matrix Builder</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="matrix-builder">
                    <p class="modal-description">
                        Configure matrix builds to run your pipeline across multiple configurations
                    </p>
                    
                    <div class="matrix-config">
                        <h4>Matrix Dimensions</h4>
                        <div id="matrix-dimensions"></div>
                        <button class="btn btn-secondary" onclick="window.pipelineBuilder && window.pipelineBuilder.addMatrixDimension()">
                            <i class="fas fa-plus"></i> Add Dimension
                        </button>
                    </div>
                    
                    <div class="matrix-preview">
                        <h4>Matrix Preview</h4>
                        <pre id="matrix-preview-content">No matrix configured</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dependency Manager Modal -->
    <div id="dependency-manager-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-project-diagram"></i> Dependency Manager</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="dependency-manager">
                    <div class="dependency-tabs">
                        <div class="tab-header">
                            <button class="btn btn-outline dependency-type-btn active" data-type="explicit">
                                <i class="fas fa-link"></i> Explicit Dependencies
                            </button>
                            <button class="btn btn-outline dependency-type-btn" data-type="file-based">
                                <i class="fas fa-file"></i> File-Based Dependencies
                            </button>
                            <button class="btn btn-outline dependency-type-btn" data-type="conditional">
                                <i class="fas fa-code-branch"></i> Conditional Dependencies
                            </button>
                        </div>
                    </div>
                    
                    <div class="dependency-content">
                        <div id="explicit-dependencies" class="dependency-section">
                            <div class="step-dependencies">
                                <h5>Step Dependencies</h5>
                                <div id="step-dependency-list"></div>
                            </div>
                        </div>
                        
                        <div id="file-based-dependencies" class="dependency-section" style="display: none;">
                            <div class="file-dependency-builder">
                                <h5>File Change Dependencies</h5>
                                <div class="file-patterns">
                                    <div class="property-group">
                                        <label>Watch Patterns</label>
                                        <textarea placeholder="src/**/*.js&#10;tests/**/*.test.js&#10;package.json"></textarea>
                                        <small>File patterns that trigger this step when changed</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="conditional-dependencies" class="dependency-section" style="display: none;">
                            <div class="conditional-dependency-builder">
                                <h5>Conditional Dependencies</h5>
                                <div class="condition-builder">
                                    <div class="condition-group">
                                        <div class="condition-header">
                                            <h4>IF Conditions</h4>
                                            <button class="btn btn-secondary btn-small" data-action="add-condition" data-type="if">
                                                <i class="fas fa-plus"></i> Add Condition
                                            </button>
                                        </div>
                                        <div id="if-conditions"></div>
                                    </div>
                                    
                                    <div class="condition-group">
                                        <div class="condition-header">
                                            <h4>UNLESS Conditions</h4>
                                            <button class="btn btn-secondary btn-small" data-action="add-condition" data-type="unless">
                                                <i class="fas fa-plus"></i> Add Condition
                                            </button>
                                        </div>
                                        <div id="unless-conditions"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- YAML Preview Modal -->
    <div id="yaml-preview-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-code"></i> Pipeline YAML Preview</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="yaml-preview">
                    <div class="yaml-actions">
                        <button class="btn btn-primary" onclick="window.pipelineBuilder && window.pipelineBuilder.copyYAML()">
                            <i class="fas fa-copy"></i> Copy to Clipboard
                        </button>
                        <button class="btn btn-secondary" onclick="window.pipelineBuilder && window.pipelineBuilder.downloadYAML()">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                    <textarea id="yaml-output" class="yaml-output" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-grid">
                    <div class="shortcut-category">
                        <h4>General</h4>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>K</kbd>
                            <span>Command Palette</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>S</kbd>
                            <span>Export YAML</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>N</kbd>
                            <span>Clear Pipeline</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>E</kbd>
                            <span>Load Example</span>
                        </div>
                    </div>
                    <div class="shortcut-category">
                        <h4>Pipeline</h4>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>P</kbd>
                            <span>Plugin Catalog</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>M</kbd>
                            <span>Matrix Builder</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>T</kbd>
                            <span>Step Templates</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>G</kbd>
                            <span>Dependency Graph</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Loading Order - FIXED: Correct dependency order -->
    <script src="js/yaml-generator.js"></script>
    <script src="js/pipeline-patterns.js"></script>
    <script src="js/pipeline-builder.js"></script>
    <script src="js/enhanced-pipeline-builder.js"></script>
    <script src="js/dependency-graph.js"></script>
    <script src="js/main-init.js"></script>
    <script src="js/app.js"></script>
</body>
</html>