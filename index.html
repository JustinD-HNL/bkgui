<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buildkite Pipeline Builder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Main Application -->
    <div id="app-container" class="app-container">
        <!-- Header - FIXED: Title now properly positioned at top -->
        <header class="header">
            <div class="header-content">
                <div class="header-brand">
                    <i class="fas fa-stream"></i>
                    <h1>Buildkite Pipeline Builder</h1>
                    <span class="version">Enhanced v2.0</span>
                </div>
                <div class="header-actions">
                    <button id="load-example" class="btn btn-secondary">
                        <i class="fas fa-file-import"></i>
                        Load Example
                    </button>
                    <button id="clear-pipeline" class="btn btn-secondary">
                        <i class="fas fa-trash"></i>
                        Clear All
                    </button>
                    <button id="export-yaml" class="btn btn-primary">
                        <i class="fas fa-download"></i>
                        Export YAML
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content - 3 Column Layout - FIXED: Proper grid structure -->
        <main class="main-content">
            <!-- Enhanced Sidebar - Left Column -->
            <aside class="sidebar enhanced-sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-toolbox"></i> Step Types</h3>
                    <p>Drag steps to build your pipeline</p>
                </div>

                <!-- Core Steps -->
                <div class="step-category">
                    <h4><i class="fas fa-star"></i> Core Steps</h4>
                    <div class="step-palette">
                        <div class="step-type" draggable="true" data-step-type="command">
                            <i class="fas fa-terminal"></i>
                            <span>Command Step</span>
                            <small>Execute shell commands</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="wait">
                            <i class="fas fa-hourglass-half"></i>
                            <span>Wait Step</span>
                            <small>Wait for previous steps</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="block">
                            <i class="fas fa-hand-paper"></i>
                            <span>Block Step</span>
                            <small>Manual approval gate</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="input">
                            <i class="fas fa-keyboard"></i>
                            <span>Input Step</span>
                            <small>Collect user input</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="trigger">
                            <i class="fas fa-bolt"></i>
                            <span>Trigger Step</span>
                            <small>Trigger another pipeline</small>
                        </div>
                        <div class="step-type" draggable="true" data-step-type="group">
                            <i class="fas fa-layer-group"></i>
                            <span>Group Step</span>
                            <small>Group multiple steps</small>
                        </div>
                    </div>
                </div>

                <!-- Advanced Steps -->
                <div class="step-category">
                    <h4><i class="fas fa-tools"></i> Advanced</h4>
                    <div class="step-palette">
                        <div class="step-type" draggable="true" data-step-type="pipeline-upload">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Pipeline Upload</span>
                            <small>Upload dynamic pipeline</small>
                        </div>
                    </div>
                </div>

                <!-- Sidebar Actions -->
                <div class="sidebar-actions">
                    <!-- Quick Actions Grid -->
                    <div class="quick-actions">
                        <button class="action-btn" data-action="plugin-catalog">
                            <i class="fas fa-store"></i>
                            <span>Plugin Catalog</span>
                        </button>
                        <button class="action-btn" data-action="matrix-builder">
                            <i class="fas fa-th"></i>
                            <span>Matrix Builder</span>
                        </button>
                        <button class="action-btn" data-action="step-templates">
                            <i class="fas fa-file-alt"></i>
                            <span>Step Templates</span>
                        </button>
                        <button class="action-btn" data-action="dependency-manager">
                            <i class="fas fa-sitemap"></i>
                            <span>Dependencies</span>
                        </button>
                    </div>

                    <!-- Plugin Quickstart -->
                    <div class="plugin-quickstart">
                        <div class="plugin-quick" data-plugin="docker">
                            <i class="fab fa-docker"></i>
                            <span>Docker</span>
                        </div>
                        <div class="plugin-quick" data-plugin="artifacts">
                            <i class="fas fa-archive"></i>
                            <span>Artifacts</span>
                        </div>
                        <div class="plugin-quick" data-plugin="ecr">
                            <i class="fab fa-aws"></i>
                            <span>AWS ECR</span>
                        </div>
                        <div class="plugin-quick" data-plugin="slack">
                            <i class="fab fa-slack"></i>
                            <span>Slack</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Pipeline Canvas - Center Column - FIXED: Proper drop zone structure -->
            <section class="pipeline-canvas">
                <div class="canvas-header">
                    <h2><i class="fas fa-stream"></i> Pipeline Steps</h2>
                    <div class="canvas-actions">
                        <button id="validate-pipeline" class="btn btn-secondary">
                            <i class="fas fa-check-circle"></i>
                            Validate
                        </button>
                        <button class="btn btn-outline" data-action="pipeline-validator">
                            <i class="fas fa-clipboard-check"></i>
                            Advanced Validation
                        </button>
                    </div>
                </div>

                <!-- Drop Zone for Pipeline Steps -->
                <div id="pipeline-steps" class="pipeline-steps">
                    <!-- Steps will be rendered here -->
                    <div class="empty-pipeline">
                        <div class="empty-content">
                            <i class="fas fa-hand-paper"></i>
                            <h3>Start Building Your Pipeline</h3>
                            <p>Drag step types from the sidebar to create your pipeline</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Properties Panel - Right Column -->
            <aside class="properties-panel">
                <div class="properties-header">
                    <h3><i class="fas fa-cog"></i> Properties</h3>
                    <span class="step-count">0 steps</span>
                </div>
                
                <div id="properties-content" class="properties-content">
                    <p class="no-selection">Select a step to view its properties</p>
                </div>
            </aside>
        </main>

        <!-- YAML Output Panel -->
        <section class="yaml-output-panel">
            <div class="yaml-header">
                <h3><i class="fas fa-file-code"></i> YAML Output</h3>
                <div class="yaml-actions">
                    <button id="validate-yaml" class="btn btn-outline">
                        <i class="fas fa-check"></i>
                        Validate
                    </button>
                    <button id="download-yaml" class="btn btn-secondary">
                        <i class="fas fa-download"></i>
                        Download
                    </button>
                </div>
            </div>
            
            <div class="yaml-content">
                <textarea id="yaml-output" placeholder="YAML will appear here when you build your pipeline..."></textarea>
                
                <div id="yaml-validation" class="yaml-validation hidden">
                    <div id="validation-content"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Command Palette -->
    <div id="command-palette" class="command-palette hidden">
        <div class="command-palette-content">
            <div class="command-palette-header">
                <i class="fas fa-search"></i>
                <input type="text" class="command-palette-input" placeholder="Search commands..." />
                <button class="command-palette-close">&times;</button>
            </div>
            <div class="command-palette-results">
                <!-- Results will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Plugin Catalog Modal -->
    <div id="plugin-catalog-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-store"></i> Plugin Catalog</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="plugin-catalog-content" class="plugin-catalog">
                    <!-- Plugin cards will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Matrix Builder Modal -->
    <div id="matrix-builder-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-th"></i> Matrix Builder</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="matrix-builder">
                    <p>Matrix builder functionality will be available here.</p>
                    <p>Create parallel job matrices for your command steps.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Step Templates Modal -->
    <div id="step-templates-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-alt"></i> Step Templates</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="step-templates">
                    <p>Step templates will be available here.</p>
                    <p>Pre-configured step templates for common workflows.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dependency Manager Modal -->
    <div id="dependency-manager-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-sitemap"></i> Dependency Manager</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="dependency-manager">
                    <p>Dependency management functionality will be available here.</p>
                    <p>Visual dependency graph and step relationships.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dependency Graph Modal -->
    <div id="dependency-graph-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-project-diagram"></i> Pipeline Dependency Graph</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="graph-controls">
                    <button class="btn btn-secondary" data-action="reset-view">
                        <i class="fas fa-expand-arrows-alt"></i> Reset View
                    </button>
                    <button class="btn btn-secondary" data-action="auto-layout">
                        <i class="fas fa-magic"></i> Auto Layout
                    </button>
                    <button class="btn btn-secondary" data-action="export-graph">
                        <i class="fas fa-download"></i> Export SVG
                    </button>
                </div>
                <div class="dependency-graph-canvas">
                    <canvas id="dependency-canvas" width="800" height="600"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Conditional Builder Modal -->
    <div id="conditional-builder-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-code-branch"></i> Conditional Builder</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="conditional-builder">
                    <p>Conditional logic builder will be available here.</p>
                    <p>Build complex conditional execution rules.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-list">
                    <div class="shortcut-group">
                        <h4>General</h4>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>K</kbd>
                            <span>Open command palette</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>S</kbd>
                            <span>Export YAML</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>R</kbd>
                            <span>Clear pipeline</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>L</kbd>
                            <span>Load example</span>
                        </div>
                    </div>
                    <div class="shortcut-group">
                        <h4>Steps</h4>
                        <div class="shortcut-item">
                            <kbd>Delete</kbd>
                            <span>Remove selected step</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Escape</kbd>
                            <span>Close modals</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FIXED: Scripts loaded in proper order -->
    
    <!-- 1. Base dependencies first -->
    <script src="js/yaml-generator.js"></script>
    <script src="js/pipeline-patterns.js"></script>
    
    <!-- 2. Core pipeline builder class -->
    <script src="js/pipeline-builder.js"></script>
    
    <!-- 3. Enhanced classes that depend on base classes -->
    <script src="js/enhanced-pipeline-builder.js"></script>
    <script src="js/dependency-graph.js"></script>
    
    <!-- 4. Firebase auth (disabled) -->
    <script src="js/firebase-auth.js"></script>
    
    <!-- 5. Main initialization coordinator - LOADS LAST -->
    <script src="js/main-init.js"></script>
    
    <!-- 6. App-specific UI handlers - LOADS AFTER MAIN INIT -->
    <script src="js/app.js"></script>
</body>
</html>